#!groovy

pipeline {
  agent { node { label 'linux' } }
  options {
    buildDiscarder logRotator( numToKeepStr: '50' )
  }
  parameters {
    string( defaultValue: 'servlet-module-atleast', description: 'GIT branch name to build TCK (master/servlet-module-atleast)',
            name: 'TCK_BRANCH' )

    choice(
            description: 'TCK Github org',
            name: 'GITHUB_ORG_TCK',
            choices: ['olamy','eclipse-ee4j']
    )
    string( defaultValue: 'jdk11', description: 'JDK to use', name: 'JDKBUILD' )

    string( defaultValue: 'jetty-11.0.x', description: 'GIT branch name to build Jetty (jetty-11.0.x)',
            name: 'JETTY_BRANCH' )
  }

  stages {

    stage("Build/Run TCK") {
      steps {
        container('jetty-build') {
          ws('run-tck') {
            sh "rm -rf *"
            git url: 'https://github.com/${GITHUB_ORG_TCK}/jakartaee-tck/', branch: '${TCK_BRANCH}'
            timeout(time: 30, unit: 'MINUTES') {
              withEnv(["JAVA_HOME=${tool "$JDKBUILD"}",
                       "PATH+MAVEN=${env.JAVA_HOME}/bin:${tool "maven3"}/bin",
                       "MAVEN_OPTS=-Xms2g -Xmx4g -Djava.awt.headless=true"]) {
                configFileProvider([configFile(fileId: 'oss-settings.xml', variable: 'GLOBAL_MVN_SETTINGS')]) {
                  sh "mvn -ntp install:install-file -Dfile=./lib/javatest.jar -DgroupId=javatest -DartifactId=javatest -Dversion=5.0 -Dpackaging=jar -N"
                  sh "mvn -ntp -s $GLOBAL_MVN_SETTINGS -V -B -U -pl :tck-run -am clean install -Dmaven.test.failure.ignore=true -e -Pglassfish-ci-managed -T2"
                }
              }
            }
          }
        }
      }
      post {
        always {
          ws('run-tck') {
            junit testResults: '**/tck-tests-reports/TEST-**.xml'
            script {
              def built = build(job: 'tck-servlet-arquillian-experiment', propagate: false,
                      parameters: [string(name: 'TCK_BRANCH', value: "${TCK_BRANCH}"),
                                   string(name: 'JETTY_BRANCH', value: "${JETTY_BRANCH}"),
                                   string(name: 'ARQUILLIAN_JETTY_BRANCH', value: "master"),
                                   string(name: 'JETTY_VERSION', value: "SNAPSHOT"),
                                   string(name: 'GITHUB_ORG_ARQUILLIAN', value: "arquillian"),
                                   string(name: 'JDKBUILD', value: "${JDKBUILD}"),
                                   string(name: 'GITHUB_ORG_TCK', value: 'olamy')])
            }
          }
        }
      }
    }
  }
}
